<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Apartment</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(to bottom, #f7d5ea 0%, #e3dafb 60%, #e3dafb 100%);
      overflow-y: auto;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Inter', Arial, sans-serif;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 50%;
      background: linear-gradient(135deg, #f7d5ea 0%, #e3dafb 100%);
      clip-path: ellipse(70% 100% at 50% 0%);
      z-index: 0;
    }
    body::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50%;
      background: linear-gradient(135deg, #e3dafb 0%, #f7d5ea 100%);
      clip-path: ellipse(70% 100% at 50% 100%);
      z-index: 0;
    }
    .apt-card {
      position: relative;
      z-index: 10;
      max-width: 28rem;
      width: 100%;
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      border: 1px solid #e5e7eb;
      padding: 2.5rem 2rem 3.5rem 2rem;
      margin: 2rem 0 3rem 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 80vh;
      justify-content: flex-start;
    }
    .close-btn {
      position: absolute;
      top: 1.25rem;
      left: 1.25rem;
      background: white;
      border-radius: 9999px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 0.5rem 0.7rem;
      z-index: 20;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }
    .close-btn:hover {
      background: #f3e8ff;
    }
    h2 {
      text-align: center;
      margin-bottom: 24px;
      font-size: 1.5rem;
      font-weight: bold;
      color: #541257;
    }
    label {
      font-weight: 600;
      color: #541257;
      margin-bottom: 6px;
      display: block;
      margin-top: 12px;
    }
    select, input[type="text"], input[type="date"], textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      background: #f8f6fc;
      color: #541257;
      transition: border 0.2s;
      outline: none;
    }
    select:focus, input[type="text"]:focus, input[type="date"]:focus, textarea:focus {
      border: 1.5px solid #a23bb1;
      background: #f3e8ff;
    }
    .features {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 24px;
      justify-content: center;
    }
    .feature-btn {
      padding: 10px 16px;
      border: 1.5px solid #a23bb1;
      border-radius: 20px;
      font-size: 14px;
      background-color: #fff;
      color: #a23bb1;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .feature-btn.active {
      background-color: #a23bb1;
      color: white;
      border-color: #a23bb1;
    }
    .rooms {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      justify-content: center;
    }
    .rooms button {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1.5px solid #a23bb1;
      border-radius: 20px;
      background-color: #fff;
      color: #a23bb1;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .rooms button.active {
      background-color: #a23bb1;
      color: white;
      border-color: #a23bb1;
    }
    textarea {
      resize: vertical;
      height: 80px;
    }
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
      margin-bottom: 16px;
    }
    .photo-upload {
      width: 100%;
      aspect-ratio: 1;
      background-color: #f3e8ff;
      border: 2.5px dashed #a23bb1;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 38px;
      color: #a23bb1;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: border 0.2s, background 0.2s;
      min-width: 90px;
      min-height: 90px;
      max-width: 140px;
      max-height: 140px;
      margin: 0 auto;
    }
    .photo-upload:hover {
      background-color: #e0d9ff;
      border-color: #541257;
    }
    .photo-upload span {
      font-size: 2.5rem;
      font-weight: bold;
      color: #a23bb1;
      opacity: 0.7;
      pointer-events: none;
      transition: color 0.2s;
    }
    .photo-upload img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
      display: none;
    }
    .photo-upload input {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    .submit-btn {
      width: 100%;
      background-color: #a23bb1;
      color: white;
      padding: 18px 0 18px 0;
      border: none;
      border-radius: 24px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      margin-top: 32px;
      margin-bottom: 0;
      box-shadow: 0 2px 8px rgba(162,59,177,0.08);
      transition: background 0.2s;
      letter-spacing: 0.5px;
    }
    .submit-btn:hover {
      background-color: #541257;
    }
    .popup {
      position: fixed;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      background-color: #4BB543;
      color: white;
      padding: 18px 32px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.13);
      font-size: 1.1rem;
      font-weight: 600;
      display: none;
      z-index: 9999;
      text-align: center;
      letter-spacing: 0.5px;
    }
    .section-title {
      font-weight: bold;
      color: #541257;
      font-size: 1.1rem;
      margin-bottom: 8px;
      margin-top: 18px;
      text-align: left;
      width: 100%;
    }
  </style>
</head>
<body>

  <div class="apt-card">
    <a href="apt-room.html" class="close-btn" title="Back to main selection">
      <i class="fas fa-times text-gray-700 text-xl"></i>
    </a>
    <h2>Upload A New Apartment</h2>

    <div class="section-title">City</div>
    <select id="city">
      <option disabled selected value="">City</option>
      <option>Tel Aviv</option>
      <option>Jerusalem</option>
      <option>Haifa</option>
    </select>

    <div class="section-title">Address</div>
    <input type="text" id="address" placeholder="Enter address" style="width:100%;padding:12px;margin-bottom:16px;border:1px solid #e5e7eb;border-radius:12px;font-size:15px;background:#f8f6fc;color:#541257;transition:border 0.2s;outline:none;" />

    <div class="section-title">Area</div>
    <select id="area">
      <option disabled selected value="">Area</option>
      <option>Center</option>
      <option>North</option>
      <option>South</option>
    </select>

    <div class="section-title">Contract</div>
    <select id="contract">
      <option disabled selected value="">Contract</option>
      <option>Long term</option>
      <option>Short term</option>
      <option>Sublet</option>
    </select>

    <div class="section-title">Features</div>
    <div class="features">
      <button class="feature-btn">üè† Balcony</button>
      <button class="feature-btn">üõó Elevator</button>
      <button class="feature-btn">üõ° Mamad</button>
      <button class="feature-btn">üì∂ Wifi</button>
      <button class="feature-btn">üöó Parking</button>
      <button class="feature-btn">üì¶ Storage</button>
      <button class="feature-btn">‚ôø Accessible</button>
    </div>

    <div class="section-title">How many rooms are there in total in the apartment?</div>
    <div class="rooms">
      <button>2</button>
      <button>2.5</button>
      <button>3</button>
      <button>4</button>
      <button>5</button>
    </div>

    <div class="section-title">Room price</div>
    <input type="text" id="roomPrice" placeholder="0" />

    <div class="section-title">Detail of furniture in the room</div>
    <textarea placeholder="Describe the furniture..."></textarea>

    <div class="section-title">Date of entry</div>
    <input type="date" value="2025-01-01" />

    <div class="section-title">Add photos</div>
    <div class="photo-grid">
      <div class="photo-upload">
        <span>+</span>
        <input type="file" accept="image/*" onchange="previewImage(event, 0)">
        <img id="preview-0">
      </div>
      <div class="photo-upload">
        <span>+</span>
        <input type="file" accept="image/*" onchange="previewImage(event, 1)">
        <img id="preview-1">
      </div>
      <div class="photo-upload">
        <span>+</span>
        <input type="file" accept="image/*" onchange="previewImage(event, 2)">
        <img id="preview-2">
      </div>
      <div class="photo-upload">
        <span>+</span>
        <input type="file" accept="image/*" onchange="previewImage(event, 3)">
        <img id="preview-3">
      </div>
      <div class="photo-upload">
        <span>+</span>
        <input type="file" accept="image/*" onchange="previewImage(event, 4)">
        <img id="preview-4">
      </div>
      <div class="photo-upload">
        <span>+</span>
        <input type="file" accept="image/*" onchange="previewImage(event, 5)">
        <img id="preview-5">
      </div>
    </div>

    <button class="submit-btn" id="submitBtn" type="button">I'm done</button>
  </div>

  <!-- ‚úÖ Popup Element -->
  <div id="successPopup" class="popup">
    <span style="font-size:1.2em;">üéâ</span><br>
    Your apartment was uploaded!<br>
    Now let's find you a roommate.
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://vgkvkmpckneceqfggzes.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZna3ZrbXBja25lY2VxZmdnemVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1NDA0NjAsImV4cCI6MjA2MjExNjQ2MH0.1ZEMsUleNaBrePUuagdZAKL2gYA-9-vM9wrTIW8-tdU';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // GCP upload function for Apt_Pics
    async function uploadAptImageToGCP(file) {
      try {
        const timestamp = new Date().getTime();
        const filename = `Apt_Pics/${timestamp}_${file.name}`;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('filename', filename);
        const response = await fetch('https://roomatch-backend-euaxovukxa-ew.a.run.app/api/upload-to-gcp', {
          method: 'POST',
          body: formData
        });
        if (!response.ok) throw new Error('Upload failed');
        const data = await response.json();
        return data.publicUrl;
      } catch (error) {
        console.error('Error uploading to GCP:', error);
        throw error;
      }
    }

    // --- Data Service Abstraction ---
    async function getApartments() {
      return JSON.parse(localStorage.getItem('apartments') || '[]');
    }
    async function saveApartments(apartments) {
      localStorage.setItem('apartments', JSON.stringify(apartments));
    }
    async function getRoommateSeekers() {
      return JSON.parse(localStorage.getItem('roommate_seekers') || '[]');
    }
    async function saveRoommateSeekers(seekers) {
      localStorage.setItem('roommate_seekers', JSON.stringify(seekers));
    }
    async function getUserApartment() {
      return JSON.parse(localStorage.getItem('user_apartment') || 'null');
    }
    async function saveUserApartment(apt) {
      localStorage.setItem('user_apartment', JSON.stringify(apt));
    }
    // --- End Data Service ---

    // Feature toggle multi-select
    document.querySelectorAll('.feature-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.classList.toggle('active');
      });
    });

    // Room button toggle - single select
    document.querySelectorAll('.rooms button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.rooms button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    // Room price integer-only input
    document.getElementById('roomPrice').addEventListener('input', function () {
      this.value = this.value.replace(/[^\d]/g, '');
    });

    // Image preview
    function previewImage(event, index) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById('preview-' + index);
          img.src = e.target.result;
          img.style.display = "block";
          event.target.previousElementSibling.style.display = "none"; // hides "+"
        };
        reader.readAsDataURL(file);
      }
    }

    // Collect selected files for upload
    function getSelectedAptFiles() {
      const files = [];
      document.querySelectorAll('.photo-upload input[type="file"]').forEach(input => {
        if (input.files && input.files[0]) {
          files.push(input.files[0]);
        }
      });
      return files;
    }

    // ‚úÖ Show popup on submit with validation
    document.getElementById('submitBtn').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'Uploading...';

      try {
        // Validate city
        const city = document.getElementById('city').value;
        if (!city) throw new Error('Please select a city.');
        // Validate address
        const address = document.getElementById('address').value.trim();
        if (!address) throw new Error('Please enter an address.');
        // Validate area
        const area = document.getElementById('area').value;
        if (!area) throw new Error('Please select an area.');
        // Validate contract
        const contract = document.getElementById('contract').value;
        if (!contract) throw new Error('Please select a contract type.');
        // Validate at least one feature
        const features = document.querySelectorAll('.feature-btn.active');
        if (features.length === 0) throw new Error('Please select at least one feature.');
        // Validate room selection
        const rooms = document.querySelectorAll('.rooms button.active');
        if (rooms.length === 0) throw new Error('Please select the number of rooms.');
        // Validate price
        const price = document.getElementById('roomPrice').value.trim();
        if (!price || isNaN(price) || Number(price) <= 0) throw new Error('Please enter a valid room price.');
        // Validate furniture description
        const furniture = document.querySelector('textarea').value.trim();
        if (!furniture) throw new Error('Please describe the furniture.');
        // Validate date
        const date = document.querySelector('input[type="date"]').value;
        if (!date) throw new Error('Please select a date of entry.');

        // Upload all selected images to GCP
        const aptFiles = getSelectedAptFiles();
        let imageUrls = [];
        if (aptFiles.length > 0) {
          // Optionally show a progress bar or spinner here
          for (let i = 0; i < aptFiles.length; i++) {
            try {
              imageUrls.push(await uploadAptImageToGCP(aptFiles[i]));
            } catch (err) {
              alert('Failed to upload image #' + (i+1) + ': ' + err.message);
              // Optionally: break or continue
            }
          }
        }
        if (imageUrls.length === 0) {
          throw new Error('Please upload at least one apartment photo.');
        }

        // Get user id for roommate_id
        const userId = parseInt(localStorage.getItem('user_id'));
        if (!userId) throw new Error('User not found. Please log in again.');

        function stripEmojis(str) {
          return str.replace(/^[^a-zA-Z0-9]+/, '').trim();
        }
        const featuresArray = Array.from(features).map(f => stripEmojis(f.textContent.trim()));
        const { error } = await supabaseClient
          .from('apartments')
          .insert([{
            address: address,
            city: city,
            area: area,
            contract_type: contract,
            features: featuresArray,
            num_rooms: parseFloat(rooms[0].textContent.trim()),
            price_per_month: parseInt(price),
            description: furniture,
            date_of_entry: date,
            image_urls: imageUrls,
            roommate_id: [userId]
          }]);
        if (error) throw new Error(error.message);

        // Show success popup and redirect
        const popup = document.getElementById('successPopup');
        popup.style.display = 'block';
        setTimeout(() => {
          window.location.href = 'roomate.html';
        }, 2000);

      } catch (err) {
        alert(err.message || 'Something went wrong');
      } finally {
        btn.disabled = false;
        btn.textContent = "I'm done";
      }
    });
  </script>

</body>
</html>



