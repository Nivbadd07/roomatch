<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROOMATCH - Upload Apartment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body {
            min-height: 100vh;
            background: linear-gradient(120deg, #f7d5ea 0%, #e3dafb 60%, #e3dafb 100%);
            background-attachment: fixed;
            overflow-x: hidden;
            font-family: 'Inter', Arial, sans-serif;
            position: relative;
        }
        .upload-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .upload-card {
            background: rgba(255,255,255,0.97);
            box-shadow: 0 12px 48px 0 rgba(162, 59, 177, 0.18);
            border-radius: 1.5rem;
            border: 2.5px solid #e0d9ff;
            padding: 3.5rem 2rem;
            max-width: 900px;
            width: 100%;
        }
        .upload-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: #2d1b4d;
            margin-bottom: 1rem;
            text-align: center;
        }
        .upload-subtitle {
            color: #a23bb1;
            font-size: 1.2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .form-label {
            font-weight: 600;
            color: #2d1b4d;
        }
        .form-input {
            padding: 1rem;
            border: 2px solid #e0d9ff;
            border-radius: 1rem;
            font-size: 1rem;
            background: #f8f6fc;
            color: #541257;
            transition: border 0.2s;
        }
        .form-input:focus {
            border-color: #a23bb1;
            outline: none;
            background: #f3e8ff;
        }
        .upload-btn {
            background: linear-gradient(90deg, #a23bb1, #fde2f3 80%);
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(162,59,177,0.2);
        }
        .upload-btn:disabled {
            background: #e0d9ff;
            color: #a23bb1;
            cursor: not-allowed;
            transform: none;
        }
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 1rem;
            margin-top: 1rem;
        }
        .error-message {
            color: #d32f2f;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .success-message {
            color: #2e7d32;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="upload-container">
        <div class="upload-card">
            <h1 class="upload-title">Upload Apartment</h1>
            <p class="upload-subtitle">Share your apartment details with potential roommates</p>
            
            <form id="uploadForm" class="upload-form">
                <div class="form-group">
                    <label class="form-label">Apartment Title</label>
                    <input type="text" id="title" class="form-input" required placeholder="e.g., Cozy 2BR in Downtown">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="description" class="form-input" rows="4" required placeholder="Describe your apartment..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" id="address" class="form-input" required placeholder="Full address">
                </div>

                <div class="form-group">
                    <label class="form-label">Price (per month)</label>
                    <input type="number" id="price" class="form-input" required placeholder="Monthly rent">
                </div>

                <div class="form-group">
                    <label class="form-label">Number of Bedrooms</label>
                    <input type="number" id="bedrooms" class="form-input" required min="1" max="10">
                </div>

                <div class="form-group">
                    <label class="form-label">Number of Bathrooms</label>
                    <input type="number" id="bathrooms" class="form-input" required min="1" max="10">
                </div>

                <div class="form-group">
                    <label class="form-label">Apartment Photos</label>
                    <input type="file" id="photos" class="form-input" accept="image/*" multiple required>
                    <div id="photoPreview" class="mt-4 flex flex-wrap gap-4"></div>
                </div>

                <button type="submit" class="upload-btn" id="submitBtn">Upload Apartment</button>
                <div id="errorMsg" class="error-message"></div>
                <div id="successMsg" class="success-message"></div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://vgkvkmpckneceqfggzes.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZna3ZrbXBja25lY2VxZmdnemVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1NDA0NjAsImV4cCI6MjA2MjExNjQ2MH0.1ZEMsUleNaBrePUuagdZAKL2gYA-9-vM9wrTIW8-tdU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Function to upload images to GCP
        async function uploadImagesToGCP(files) {
            const uploadedUrls = [];
            for (const file of files) {
                try {
                    // Create a unique filename
                    const timestamp = new Date().getTime();
                    const filename = `Apartment_Pics/${timestamp}_${file.name}`;
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('filename', filename);
                    
                    // Send to backend endpoint
                    const response = await fetch('https://roomatch-test-backend-109620478954.europe-west1.run.app/api/upload-to-gcp', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('Upload failed');
                    }
                    
                    const data = await response.json();
                    uploadedUrls.push(data.publicUrl);
                } catch (error) {
                    console.error('Error uploading to GCP:', error);
                    throw error;
                }
            }
            return uploadedUrls;
        }

        // Handle photo preview
        document.getElementById('photos').addEventListener('change', function(e) {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-preview';
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        });

        // Handle form submission
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');
            
            submitBtn.disabled = true;
            errorMsg.textContent = '';
            successMsg.textContent = '';

            try {
                // Get form data
                const title = document.getElementById('title').value;
                const description = document.getElementById('description').value;
                const address = document.getElementById('address').value;
                const price = document.getElementById('price').value;
                const bedrooms = document.getElementById('bedrooms').value;
                const bathrooms = document.getElementById('bathrooms').value;
                const photos = document.getElementById('photos').files;

                // Upload photos
                const photoUrls = await uploadImagesToGCP(photos);

                // Get current user ID from localStorage
                const userId = localStorage.getItem('user_id');
                if (!userId) {
                    throw new Error('User not logged in');
                }

                // Insert into Supabase
                const { data, error } = await supabaseClient
                    .from('apartments')
                    .insert([{
                        title: title,
                        description: description,
                        address: address,
                        price: parseInt(price),
                        bedrooms: parseInt(bedrooms),
                        bathrooms: parseInt(bathrooms),
                        photos: photoUrls,
                        owner_id: userId,
                        status: 'available'
                    }]);

                if (error) throw error;

                successMsg.textContent = 'Apartment uploaded successfully!';
                setTimeout(() => {
                    window.location.href = 'apt-room.html';
                }, 2000);

            } catch (error) {
                errorMsg.textContent = error.message || 'Error uploading apartment';
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
